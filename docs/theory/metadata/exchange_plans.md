---
sidebar_position: 6
sidebar_label: Планы обмена и РИБ
title: Планы обмена и РИБ
---
**План обмена** — объект конфигурации для организации обмена данными между узлами.

**РИБ** — частный случай использования планов обмена с централизованным управлением конфигурацией.

## Иерархия и взаимосвязь
```
План обмена (базовый механизм)
    │
    ├── Обычный обмен (разные конфигурации)
    │
    └── РИБ (специализированный обмен)
        ├── Главный узел (изменяет конфигурацию)
        └── Подчиненные узлы (только данные)
```

## Ключевые концепции плана обмена

| Концепция | Описание | Важно |
|---|---|---|
| **Узлы плана** | Участники обмена (как элементы справочника) | Каждая база — предопределенный узел в своем плане |
| **Несколько планов** | Разные составы данных/механизмы для разных узлов | Гибкая настройка обмена |
| **Объекты обмена** | Данные для передачи: объекты БД + необъектные данные | Документы, справочники, регистры, константы |
| **Механизм регистрации** | Отслеживание изменений через свойство `ОбменДанными` | Формирует записи в таблицах регистрации изменений |

#### Авторегистрация изменений:
| Режим | Механизм | Где настраивать |
|---|---|---|
| **ВКЛЮЧЕНА** | Регистрируются любое изменение объекта (включая перепроведение). План обмена автоматически заполняет `ОбменДанными.Получатели` | Состав данных плана обмена → признак Авторегистрация |
| **ВЫКЛЮЧЕНА** | Разработчик программно заполняет `ОбменДанными.Получатели` | Обработчики `ПередЗаписью()` и `ПередУдалением()`, Если после записи то использовать ПланОбмена.ЗарегистрироватьИзменения |

## Архитектура плана обмена

#### 1. **Регистрация изменений**
- Каждый объект обмена имеет свойство `ОбменДанными`
- При записи/удалении → формируются записи в таблице регистрации
- Одна запись на каждый узел-получатель

#### 2. **Таблицы регистрации**
- Отдельная таблица для каждого типа объектов обмена
- Содержит: ссылку на объект, узел-получатель, номер сообщения
- Создаются только если объект в составе плана обмена

#### 3. **Инфраструктура сообщений**
- Сообщение = единица обмена информации
- Уникальный номер в рамках плана обмена
- Подтверждения приема через номер последнего принятого сообщения

##  Особенности РИБ

| Аспект | Обычный план обмена | РИБ |
|---|---|---|
| **Конфигурация** | Может отличаться | Одинаковая, изменяется только в главном узле |
| **Направленность** | Любая (peer-to-peer) | Иерархическая (центр → подчиненные) |
| **Автономность** | Полная | Ограниченная (без изменений конфигурации) |
| **Использование** | Интеграция разных систем | Распределение одной системы |

#### Критические ограничения РИБ:
1. **Главный узел** — единственный источник изменений конфигурации
2. **Конфликты** — разрешаются в пользу главного узла
3. **Зависимость** — подчиненные не могут работать без обновлений конфигурации

## Критические нюансы

#### Производительность:
1. **Авторегистрация ВКЛ** → больше записей в таблице регистрации, возможны взаимные транзакционные блокировки
2. **Таблицы регистрации** → дополнительная нагрузка при записи объектов
3. **Очистка записей** → по подтверждениям от узлов-получателей

#### При ОбменДанными.Загрузка = Истина
НЕ работают:
 - ПриУстановкеНомера(), ПриУстановкеКода()
 - ОбработкаПроведения() (документов)
 - Автоматические заполнения и проверки
 - ПередЗаписью() и ПриЗаписи() сработают, но если объект по "стандарту" (реализована проверка), то фактически код их не выполнится

## Техническая реализация

#### Таблица регистрации изменений:
| Поле | Назначение | Особенности |
|---|---|---|
| **Объект** | Ссылка на измененный объект | |
| **Узел** | Узел-получатель для этого изменения | |
| **Сообщение** | Номер сообщения, в котором отправлено | Null пока не отправлено |

## Критерии выбора

#### Использовать план обмена, если:
- ✅ Нужен обмен между базами 1С
- ✅ Регулярная синхронизация данных
- ✅ Встроенные механизмы конфликтов/повторов

Для обмена с разными конфигурациямии нужны правила конвертации данных.

#### Использовать РИБ, если:
- ✅ Одна распределенная система
- ✅ Централизованное управление конфигурацией
- ✅ Иерархическая структура (центр → филиалы)

## Примеры работы

#### 1. Регистрация объекта только, если новый:
```bsl
Процедура ПередЗаписью(Отказ)
    Если Это Новый Тогда
        ОбменДанными.Получатели = Новый Массив;
        ОбменДанными.Получатели.Добавить(УзелДляОбмена);
    КонецЕсли;
КонецПроцедуры;
```

#### 2. Удалить объект из регистрации при включеной Авторегистрации:
```bsl
Процедура ПередЗаписью(Отказ)
    // Авторегистрация заполнила Получатели
    // Удаляем ненужные узлы
    Для Каждого Узел Из ОбменДанными.Получатели Цикл
        Если Не НуженЭтоУзел(Узел) Тогда
            ОбменДанными.Получатели.Удалить(Узел);
        КонецЕсли;
    КонецЦикла;
КонецПроцедуры;
```
