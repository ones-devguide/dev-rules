---
sidebar_position: 5
sidebar_label: Контроль остатков
title: Контроль остатков
---
Две методики контроля отрицательных остатков при проведении документа: **Старая** (проверка до записи) и **Новая** (проверка после записи с откатом). Выбор зависит от архитектуры и требований к параллельности.

## Сравнение методик

| Критерий | Старая методика (До записи) | Новая методика (После записи) |
|---|---|---|
| **Принцип** | 1. Заблокировать данные 2. Запросить доступные остатки 3. Если хватает — записать движения | 1. Сразу записать движения 2. Проверить отрицательные остатки 3. Если есть — откатить транзакцию |
| **Блокировки** | Нужно явно блокировать строки **перед** запросом (`Новый БлокировкаДанных`) | Достаточно `БлокироватьДляИзменения`|
| **Запрос остатков** | Сложный: соединение таблиц документа и регистра | Простой: отбор по отрицательным значениям в одной таблице |
| **Производительность** | Медленнее (запрос на получение остатков + предварительная блокировка) | Быстрее (Нет необходимости очищать старые движения документа, сокращение времени блокировки и отсутствие соединения таблиц в запросе на получение остатков) |
| **Когда использовать** | Когда **нужны данные из регистра** для расчета (например, себестоимость) | Когда **все данные есть в документе** (количество, номенклатура) |

## Ключевые механизмы

#### **Режим разделения итогов**

**Что это:** Механизм, позволяющий **параллельно записывать** в один регистр (регистр накопления или регистр бухгалтерии) без блокировок даже если они работают с одинаковыми значениями (например, один склад, один товар). 

**Как работает:** При влючение в таблицу итогов добавляется разделитель. Вместо обновления одной строки итогов система создает отдельные записи. При запросе итогов эти записи складываются.

Фактически, значение разделителя - это некоторое число, выдаваемое системой в очередной транзакции и уникальное среди всех параллельно выполняемых транзакций в данный момент времени. Система выдает первое свободное число, то есть числа, выданные ранее завершившимся  транзакциям, переиспользуются.

**Когда отключать:** Например, для регистров, которые заполняются **только регламентными заданиями** (нет конкурентного доступа).

#### Свойство `БлокироватьДляИзменения`

Свойство **БлокироватьДляИзменения** не устанавливает управляемую блокировку, оно лишь выключает режим разделения итогов регистра при записи. 
Система установит блокировку на комбинацию записываемых в регистр данных.
В типовых конфигурацияю установка происходит обычно в модуле набора записей регистра накопления.

Имеет смысл использовать:

* Есть контроль остатков
* Включен разделитель итогов
* Включен режим управляемых блокировок на уровне конфигурации

**В новой методике:**  
```bsl
НаборЗаписей.БлокироватьДляИзменения = Истина; // Выключает разделение итогов
```
**В старой методике:** Нужно блокировать данные **до запроса** остатков через отдельный механизм `Новый БлокировкаДанных`.

## Ответы на ключевые вопросы

1. **Когда нельзя использовать новую методику?**
Когда **для проведения нужны данные из самого регистра остатков** (например, расчет суммы списания по средней себестоимости). Придется делать запрос до записи движений.

2. **Как обеспечить параллельную работу?**
Через **разделение итогов** (включено по умолчанию). Каждая транзакция пишет в свой "слой", итоги суммируются при чтении.

3. **Что делает `БлокироватьДляИзменения`?**
**В режиме разделения итогов:** Выключает его, включает **управляемую блокировку** на записываемые строки.  
**Без разделения итогов:** Устанавливает монопольную блокировку.

## Материалы

*   [“Новая” и “старая” методики контроля остатков](https://xn----1-bedvffifm4g.xn--p1ai/articles/2017-02-12-two-methods-for-inventory-check/)

* [Управляемые блокировки при контроле остатков](https://xn----1-bedvffifm4g.xn--p1ai/articles/2017-02-13-realtimeposting-and-datalock/)

* [Как работает свойство БлокироватьДляИзменения](https://xn----1-bedvffifm4g.xn--p1ai/news/2017-03-09-how-attribute-lock-to-change-works/)

* [ИТС: Устройство и использование режима разделения итогов регистров](https://its.1c.ru/db/metod8dev/content/1393/hdoc)

* [Статья: Режим разделения итогов](https://xn----1-bedvffifm4g.xn--p1ai/articles/%D1%80%D0%B5%D0%B6%D0%B8%D0%BC-%D1%80%D0%B0%D0%B7%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B8%D1%82%D0%BE%D0%B3%D0%BE%D0%B2/)

* [Как реализовать контроль остатков по новой методике](https://xn----1-bedvffifm4g.xn--p1ai/courses/dev-att-2019/general-methods-startpage/kbwrhbtnlj-chapter-08/)

* [Как выполнить контроль остатков по старой методике](https://xn----1-bedvffifm4g.xn--p1ai/courses/dev-att-2019/general-methods-startpage/jaimkevlqa-chapter-09/)



























